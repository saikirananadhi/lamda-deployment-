name: Backup - Deploy Lambdas from S3 (S3 Change Aware)

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::474852689250:role/DeployerRole
          aws-region: us-east-1

      # -------- hello_world --------
      - name: Check hello_world S3 object hash
        id: hw_hash
        run: |
          ETAG=$(aws s3api head-object \
            --bucket sop-reasoner1-s3 \
            --key hello_world.zip \
            --query ETag \
            --output text | tr -d '"')

          echo "etag=$ETAG" >> $GITHUB_OUTPUT

      - name: Print S3 hello_world hash
        run: |
          echo "S3 hello_world.zip ETag: ${{ steps.hw_hash.outputs.etag }}"


      - name: Get deployed hello_world hash
        id: hw_current
        run: |
          CURRENT=$(aws lambda get-function-configuration \
            --function-name sop-reasoner1-lamda \
            --query 'Environment.Variables.CODE_ETAG' \
            --output text 2>/dev/null || echo "NONE")

          echo "etag=$CURRENT" >> $GITHUB_OUTPUT

      - name: Print Lambda hello_world deployed hash
        run: |
          echo "Lambda test-hello-world CODE_ETAG: ${{ steps.hw_current.outputs.etag }}"

      - name: Deployment decision
        run: |
          if [ "${{ steps.hw_hash.outputs.etag }}" = "${{ steps.hw_current.outputs.etag }}" ]; then
            echo "No deployment needed — code already up to date."
          else
            echo "Deployment required — new code detected in S3."
          fi

      - name: Deploy hello_world if changed
        if: steps.hw_hash.outputs.etag != steps.hw_current.outputs.etag
        run: |
          aws lambda update-function-code \
            --function-name sop-reasoner1-lamda \
            --s3-bucket sop-reasoner1-s3 \
            --s3-key hello_world.zip

          aws lambda wait function-updated \
            --function-name sop-reasoner1-lamda

          aws lambda update-function-configuration \
            --function-name sop-reasoner1-lamda \
            --environment "Variables={CODE_ETAG=${{ steps.hw_hash.outputs.etag }}}"

      # -------- hello_world_2 --------
      - name: Check hello_world_2 S3 object hash
        id: hw2_hash
        run: |
          ETAG=$(aws s3api head-object \
            --bucket sop-reasoner2-s3 \
            --key hello_world_2.zip \
            --query ETag \
            --output text | tr -d '"')

          echo "etag=$ETAG" >> $GITHUB_OUTPUT

      - name: Get deployed hello_world_2 hash
        id: hw2_current
        run: |
          CURRENT=$(aws lambda get-function-configuration \
            --function-name sop-reasoner2-lamda \
            --query 'Environment.Variables.CODE_ETAG' \
            --output text 2>/dev/null || echo "NONE")

          echo "etag=$CURRENT" >> $GITHUB_OUTPUT

      - name: Deploy hello_world_2 if changed
        if: steps.hw2_hash.outputs.etag != steps.hw2_current.outputs.etag
        run: |
          aws lambda update-function-code \
            --function-name sop-reasoner2-lamda \
            --s3-bucket sop-reasoner2-s3 \
            --s3-key hello_world_2.zip

          aws lambda wait function-updated \
            --function-name sop-reasoner2-lamda

          aws lambda update-function-configuration \
            --function-name sop-reasoner2-lamda \
            --environment "Variables={CODE_ETAG=${{ steps.hw2_hash.outputs.etag }}}"
